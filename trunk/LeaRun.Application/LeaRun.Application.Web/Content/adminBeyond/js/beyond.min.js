$.fn.Tab = function (options) {
    var cfg = {
        items: [],
        width: 500,
        height: 500,
        tabcontentWidth: 498,
        tabWidth: 100,
        tabHeight: 40.5,
        tabScroll: true,
        tabScrollWidth: 19,
        tabClass: 'tab',
        tabContentClass: 'tab-div-content',
        tabClassOn: 'on',
        tabClassOff: 'off',
        tabClassClose: 'tab_close',
        tabClassInner: 'inner',
        tabClassInnerLeft: 'innerLeft',
        tabClassInnerMiddle: 'innerMiddle',
        tabClassInnerRight: 'innerRight',
        tabClassText: 'text',
        tabClassScrollLeft: 'scroll-left',
        tabClassScrollRight: 'scroll-right',
        tabClassDiv: 'tab-div',
        addEvent: null,
        leaveEvent: null,
        currentEvent: null
    };
    //默认显示第一个li
    var displayLINum = 0;
    $.extend(cfg, options);
    //判断是不是有隐藏的tab
    var tW = cfg.tabWidth * cfg.items.length;
    cfg.tabScroll ? tW -= cfg.tabScrollWidth * 2 : null;
    //tabDiv,该div是自动增加的
    var tab = $('<div />').attr('id', 'jquery_tab_div').height(cfg.tabHeight).addClass(cfg.tabClass).append('<ul />');
    //tab target content
    var tabContent = $('<div />').attr('id', 'jquery_tab_div_content').width(cfg.tabcontentWidth).height(cfg.height - cfg.tabHeight).addClass(cfg.tabContentClass);
    var ccW = (cfg.items.length * cfg.tabWidth) - cfg.width;
    var tabH = '';
    //增加一个tab下的li得模板
    var tabTemplate = '';
    tabTemplate = '<table class="' + cfg.tabClassInner + '"  id="{0}" border="0" cellpadding="0" cellspacing="0"><tr>' + '<td class="' + cfg.tabClassInnerLeft + '"></td>'
			+ '<td class="' + cfg.tabClassInnerMiddle + '"><span class="' + cfg.tabClassText + '"><i class="fa {2}"></i>&nbsp;{1}</span></td>' + '<td class="' + cfg.tabClassInnerMiddle + '"><div class="' + cfg.tabClassClose + ' ' + cfg.tabClassClose + '_noselected"></i></div></td>' + '<td class="' + cfg.tabClassInnerRight + '"></td>'
			+ '</tr></table>';
    var scrollTab = function (o, flag) {
        //当前的left
        var displayWidth = Number(tab.css('left').replace('px', ''));
        !displayWidth ? displayWidth = 0 : null;
        //显示第几个LI
        var displayNum = 0;
        var DW = 0;
        var left = 0;
        if (flag && displayWidth == 0) {
            return;
        }if (flag) {
            displayLINum--;
            left = displayWidth + tab.find('li').eq(displayLINum).width();
            left > 0 ? left = 0 : null;
        }else {
            var _rigth = $(".tab ul").width() - parseInt(tab.offset().left) * -1 - cfg.tabcontentWidth - 82;
            var _step = tab.find('li').eq(displayLINum).width();
            if (_rigth > 0) {
                if (_rigth < _step) {
                    _step = _rigth;
                }
            } else {
                return;
            }
            left = displayWidth - _step;
            displayLINum++;
        }
        if (left == 0) {
            tab.animate({ 'left': parseInt(-19) });
        } else {
            tab.animate({ 'left': parseInt(left) });
        }
    }
    function removeTab(item) {
        tab.find("#" + item.id).parents('li').remove();
        tabContent.find('#tabs_iframe_' + item.id).remove();
    }
    function addTab(item) {
        if (item.replace == true) {
            removeTab(item);
        }
        if (tab.find("#" + item.id).length == 0) {
            Loading(true);
            var innerString = tabTemplate.replace("{0}", item.id).replace("{1}", item.title).replace("{2}", item.icon);
            var liObj = $('<li class="off"></li>');
            liObj.append(innerString).appendTo(tab.find('ul')).find('table td:eq(1)').click(function () {
                liObj.Contextmenu();
                //判断当前是不是处于激活状态
                if (liObj.hasClass(cfg.tabClassOn)) return;

                var activeLi = liObj.parent().find('li.' + cfg.tabClassOn);
                activeLi.removeClass().addClass(cfg.tabClassOff);

                $(this).next().find('div').removeClass().addClass(cfg.tabClassClose);
                liObj.removeClass().addClass(cfg.tabClassOn);

                tabContent.find('iframe').hide().removeClass(cfg.tabClassOn);
                tabContent.find('#tabs_iframe_' + liObj.find('table').attr('id')).show().addClass(cfg.tabClassOn);

                cfg.currentEvent(liObj.find('.inner').attr('id'));
            })
            if (item.url) {
                var $iframe = $("<iframe id=\"tabs_iframe_" + item.id + "\" height=\"100%\" width=\"100%\" src=\"" + item.url + "\" frameBorder=\"0\"></iframe>")
                tabContent.append($iframe);
                $iframe.load(function () {
                    window.setTimeout(function () {
                        Loading(false);
                    }, 200);
                });
            }
            if (item.closed) {
                liObj.find('td:eq(2)').find('div').click(function () {
                    var li_index = tab.find('li').length;
                    removeTab(item);
                    tab.find('li:eq(' + (li_index - 2) + ')').find('table td:eq(1)').trigger("click");
                    cfg.leaveEvent(item);
                }).hover(function () {
                    if (liObj.hasClass(cfg.tabClassOn)) return;
                    $(this).removeClass().addClass(cfg.tabClassClose);
                }, function () {
                    if (liObj.hasClass(cfg.tabClassOn)) return;
                    $(this).addClass(cfg.tabClassClose + '_noselected');
                });
            }
            else {
                liObj.find('td:eq(2)').html('');
            }
            tab.find('li:eq(' + (tab.find('li').length - 1) + ')').find('table td:eq(1)').trigger("click");
            cfg.addEvent(item);
        } else {
            tab.find('li').removeClass('on').addClass('off');
            tab.find("#" + item.id).parent().removeClass('off').addClass('on');
            tabContent.find('iframe').hide().removeClass('on');
            tabContent.find('#tabs_iframe_' + item.id).show().addClass('on');
        }
    }
    function newTab(item) {
        $.cookie('currentmoduleId', item.id, { path: "/", expires: 7 });
        addTab(item);
        var nW = $(".tab ul").width() - 4;
        if (nW > cfg.width) {
            if (!cfg.tabScroll) {
                cfg.tabScroll = true;
                scrollLeft = $('<div class="' + cfg.tabClassScrollLeft + '"><i></i></div>').click(function () {
                    scrollTab(scrollLeft, true);
                });
                srcollRight = $('<div class="' + cfg.tabClassScrollRight + '"><i></i></div>').click(function () {
                    scrollTab(srcollRight, false);
                });
                cW -= cfg.tabScrollWidth * 2;
                tabContenter.width(cW);
                scrollLeft.insertBefore(tabContenter);
                srcollRight.insertBefore(tabContenter);
            }
            var _left = cfg.width - nW;
            tab.animate({ 'left': _left - 43 });
            displaylicount = tab.find('li').length;
        }
    }
    $.each(cfg.items, function (i, item) {
        addTab(item);
    });
    var scrollLeft, srcollRight;
    if (cfg.tabScroll) {
        scrollLeft = $('<div class="' + cfg.tabClassScrollLeft + '"><i></i></div>').click(function () {
            scrollTab($(this), true);
        });
        srcollRight = $('<div class="' + cfg.tabClassScrollRight + '"><i></i></div>').click(function () {
            scrollTab($(this), false);
        });
        cfg.width -= cfg.tabScrollWidth * 2;
    }
    var container = $('<div />').css({
        'position': 'relative',
        'width': cfg.width,
        'height': cfg.tabHeight
    }).append(scrollLeft).append(srcollRight).addClass(cfg.tabClassDiv);
    var tabContenter = $('<div />').css({
        'width': cfg.width,
        'height': cfg.tabHeight,
        'float': 'left'
    }).append(tab);
    var obj = $(this).append(tabH).append(container.append(tabContenter)).append(tabContent);
    $(window).resize(function () {
        cfg.width = $(window).width() - 100;
        cfg.height = $(window).height() - 56;
        cfg.tabcontentWidth = $(window).width() - 80;
        container.width(cfg.width);
        tabContent.width(cfg.tabcontentWidth).height(cfg.height - cfg.tabHeight);
    });
    //点击第一
    tab.find('li:first td:eq(1)').click();
    return obj.extend({ 'addTab': addTab, 'newTab': newTab });
};
InitiateSideMenu = function () {
    $(".sidebar-toggler").on("click",
    function () {
        return $("#sidebar").toggleClass("hide"),
        $(".sidebar-toggler").toggleClass("active"),
        !1
    });
    var n = $("#sidebar").hasClass("menu-compact");
    $("#sidebar-collapse").on("click",
    function () {
        $("#sidebar").is(":visible") || $("#sidebar").toggleClass("hide");
        $("#sidebar").toggleClass("menu-compact");
        $(".sidebar-collapse").toggleClass("active");
        n = $("#sidebar").hasClass("menu-compact");
        n && $(".open > .submenu").removeClass("open")
        $(window).resize()
    });
    $(".sidebar-menu").on("click",
    function (t) {
        var i = $(t.target).closest("a"),
        u,
        r,
        f;
        if (i && i.length != 0) {
            if (!i.hasClass("menu-dropdown")) return n && i.get(0).parentNode.parentNode == this && (u = i.find(".menu-text").get(0), t.target != u && !$.contains(u, t.target)) ? !1 : void 0;
            if (r = i.next().get(0), !$(r).is(":visible")) {
                if (f = $(r.parentNode).closest("ul"), n && f.hasClass("sidebar-menu")) return;
                f.find("> .open > .submenu").each(function () {
                    this == r || $(this.parentNode).hasClass("active") || $(this).slideUp(200).parent().removeClass("open")
                })
            }
            return n && $(r.parentNode.parentNode).hasClass("sidebar-menu") ? !1 : ($(r).slideToggle(200).parent().toggleClass("open"), !1)
        }
    })
}
//初始化导航
loadnav = function () {
    var navJson = {};
    tablist = $("#tab_list_add").Tab({
        items: [
            { id: 'desktop', title: '欢迎首页', closed: false, icon: 'fa fa fa-desktop', url: contentPath + '/Home/Desktop' },
        ],
        tabScroll: false,
        width: $(window).width() - $("#sidebar").width(),
        height: $(window).height() - 45,
        tabcontentWidth: $(window).width() - $("#sidebar").width(),
        addEvent: function (item) {
            if (item.closed) {
                $.post(contentPath + "/Home/VisitModule", { moduleId: item.id, moduleName: item.title, moduleUrl: item.url }, function (data) { });
            }
        },
        leaveEvent: function (item) {
        },
        currentEvent: function (moduleId) {
            $.cookie('currentmoduleId', moduleId, { path: "/", expires: 7 });
        }
    });
    $.ajax({
        url: "/AuthorizeManage/Module/GetListJson",
        type: "get",
        dataType: "json",
        async: false,
        success: function (data) {
            var _html = "";
            var index = 0;
            $.each(data, function (i) {
                var row = data[i];
                if (row.ParentId == '0') {
                    index++;
                    _html += '<li>';
                    _html += '<a id=' + row.ModuleId + '  href="javascript:void(0);" class="menu-dropdown">';
                    _html += '<i class="menu-icon fa ' + row.Icon + '"></i>';
                    _html += '<span class="menu-text">' + row.FullName + '</span>';
                    _html += '<i class="menu-expand"></i>';
                    _html += '</a>';
                    _html += getsubnav(row.ModuleId, data);
                    _html += '</li>';
                    navJson[row.ModuleId] = row;
                }
            });
            $("#nav").append(_html);
            $("#nav li:first a:first").trigger("click")
            $('#nav li a').click(function () {
                var id = $(this).attr('id');
                var data = navJson[id];
                if (data.Target == "iframe") {
                    if (!$(".sidebar-collapse").hasClass('active')) {
                        $(".sidebar-collapse").trigger("click");
                    }
                    tablist.newTab({ id: id, title: data.FullName, closed: true, icon: data.Icon, url: contentPath + data.UrlAddress });
                }
            })
        }
    });
    //导航二菜单
    function getsubnav(moduleId, data) {
        var _html = '<ul class="submenu">';
        $.each(data, function (i) {
            var row = data[i];
            if (row.ParentId == moduleId) {
                if (isbelowmenu(row.ModuleId, data) == 0) {
                    _html += '<li>';
                    _html += '<a id=' + row.ModuleId + '  href="javascript:void(0);">';
                    _html += '<i class="menu-icon fa ' + row.Icon + '"></i>';
                    _html += '<span class="menu-text">' + row.FullName + '</span>';
                    _html += '</a>';
                    _html += '</li>';
                } else {
                    _html += '<li>';
                    _html += '<a id=' + row.ModuleId + '  href="javascript:void(0);" class="menu-dropdown">';
                    _html += '<i class="menu-icon fa ' + row.Icon + '"></i>';
                    _html += '<span class="menu-text">' + row.FullName + '</span>';
                    _html += '<i class="menu-expand"></i>';
                    _html += '</a>';
                    _html += getchildnav(row.ModuleId, data);
                    _html += '</li>';
                }
                navJson[row.ModuleId] = row;
            }
        });//<i class="menu-expand"></i>
        _html += '</ul>';
        return _html;
    }
    //导航三菜单
    function getchildnav(moduleId, data) {
        var _html = '<ul class="submenu">';
        $.each(data, function (i) {
            var row = data[i];
            if (row.ParentId == moduleId) {
                _html += '<li>';
                _html += '<a id=' + row.ModuleId + '  href="javascript:void(0);" >';
                _html += '<i class="menu-icon fa ' + row.Icon + '"></i>';
                _html += '<span class="menu-text">' + row.FullName + '</span>';
                _html += '</a>';
                _html += '</li>';
                navJson[row.ModuleId] = row;
            }
        });
        _html += '</ul>';
        return _html;
    }
    //判断是否有子节点
    function isbelowmenu(moduleId, data) {
        var count = 0;
        $.each(data, function (i) {
            if (data[i].ParentId == moduleId) {
                count++;
                return false;
            }
        });
        return count;
    }
}